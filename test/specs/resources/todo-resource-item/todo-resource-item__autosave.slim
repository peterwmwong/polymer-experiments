== html_test 'resources/todo-resource.html'

  / Setup
  / -----
  coffee:
    window.localStorage.removeItem 'ioi-store'
    window.localStorage.setItem 'ioi-store', JSON.stringify
      'a': {id: 'a', text: 'one',   notes: 'one notes',   done: true}
      'b': {id: 'b', text: 'two',   notes: 'two notes',   done: false}
      'c': {id: 'c', text: 'three', notes: 'three notes', done: true}

  polymer-element name="t-test"
    template
      todo-resource-item item_id="{{ item_id }}" item="{{ todo }}"
      
    coffee:
      Polymer 't-test',
        item_id: 'b'

        # Retrieved todo will be written to @todo
        todo: undefined

        # Begin test when todo has been retrieved
        todoChanged: ->
          return unless @todo
          unless @testStarted
            @testStarted = true
            @startTest()

        startTest: ->
          attrValueExpected = [
            ['text','foo',
                'a': {id: 'a', text: 'one',   notes: 'one notes',   done: true}
                'b': {id: 'b', text: 'foo',   notes: 'two notes',   done: false}
                'c': {id: 'c', text: 'three', notes: 'three notes', done: true}
            ]
            ['notes','two notes modified',
                'a': {id: 'a', text: 'one',   notes: 'one notes',   done: true}
                'b': {id: 'b', text: 'foo',   notes: 'two notes modified',   done: false}
                'c': {id: 'c', text: 'three', notes: 'three notes', done: true}
            ]
            ['done',true,
                'a': {id: 'a', text: 'one',   notes: 'one notes',   done: true}
                'b': {id: 'b', text: 'foo',   notes: 'two notes modified',   done: true}
                'c': {id: 'c', text: 'three', notes: 'three notes', done: true}
            ]
          ]

          testAttrChange = =>
            unless attrValueExpected.length
              done()
            else
              [attr, value, expected] = attrValueExpected.shift()
              DESCRIBE = "When @todo.#{attr} changes,"
              @todo[attr] = value
              console.log 'setting', attr,  ' -to-> ', value

              @async ->
                console.log JSON.stringify JSON.parse(window.localStorage.getItem('ioi-store')), undefined, 2
                console.log JSON.stringify expected, undefined, 2
                expect(JSON.parse(window.localStorage.getItem('ioi-store')), "#{DESCRIBE} updates localStorage")
                  .to.deep.equal expected

                testAttrChange()

          testAttrChange()
